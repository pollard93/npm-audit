import {
  extractVulnerabilityIds,
  getVulnerabilityTitle,
  getVulnerabilityUrl,
} from './extractVulnerabilityInfo';
import { Vulnerability } from '../../shared/types';

describe('extractVulnerabilityInfo', () => {
  const createMockVulnerability = (overrides: Partial<Vulnerability> = {}): Vulnerability => ({
    id: 1,
    name: 'test-package',
    severity: 'high',
    title: 'Default Title',
    url: 'https://default.url',
    range: '*',
    via: [
      {
        source: 123456,
        name: 'test-package',
        dependency: 'test-package',
        title: 'Test vulnerability title',
        url: 'https://npmjs.com/advisories/123456',
        severity: 'high',
        range: '*',
      },
    ],
    effects: [],
    fixAvailable: false,
    ...overrides,
  });

  describe('extractVulnerabilityIds', () => {
    it('should extract source IDs from via array', () => {
      const vuln = createMockVulnerability({
        via: [
          {
            source: 111,
            name: 'pkg',
            dependency: 'pkg',
            title: 'Issue 1',
            url: 'https://example.com/111',
            severity: 'high',
            range: '*',
          },
          {
            source: 222,
            name: 'pkg',
            dependency: 'pkg',
            title: 'Issue 2',
            url: 'https://example.com/222',
            severity: 'high',
            range: '*',
          },
        ],
      });

      const ids = extractVulnerabilityIds(vuln);
      expect(ids).toEqual([111, 222]);
    });

    it('should ignore string entries in via array', () => {
      const vuln = createMockVulnerability({
        via: ['some-package', 'another-package'],
      });

      const ids = extractVulnerabilityIds(vuln);
      expect(ids).toEqual([]);
    });

    it('should handle mixed via entries', () => {
      const vuln = createMockVulnerability({
        via: [
          'some-package',
          {
            source: 333,
            name: 'pkg',
            dependency: 'pkg',
            title: 'Issue',
            url: 'https://example.com/333',
            severity: 'high',
            range: '*',
          },
        ],
      });

      const ids = extractVulnerabilityIds(vuln);
      expect(ids).toEqual([333]);
    });

    it('should return empty array for empty via', () => {
      const vuln = createMockVulnerability({ via: [] });
      const ids = extractVulnerabilityIds(vuln);
      expect(ids).toEqual([]);
    });
  });

  describe('getVulnerabilityTitle', () => {
    it('should return title from first via object', () => {
      const vuln = createMockVulnerability();
      const title = getVulnerabilityTitle(vuln);
      expect(title).toBe('Test vulnerability title');
    });

    it('should fall back to vulnerability title', () => {
      const vuln = createMockVulnerability({
        title: 'Fallback Title',
        via: ['string-only'],
      });
      const title = getVulnerabilityTitle(vuln);
      expect(title).toBe('Fallback Title');
    });

    it('should return Unknown for no title', () => {
      const vuln = createMockVulnerability({
        title: '',
        via: [],
      });
      const title = getVulnerabilityTitle(vuln);
      expect(title).toBe('Unknown vulnerability');
    });
  });

  describe('getVulnerabilityUrl', () => {
    it('should return URL from first via object', () => {
      const vuln = createMockVulnerability();
      const url = getVulnerabilityUrl(vuln);
      expect(url).toBe('https://npmjs.com/advisories/123456');
    });

    it('should fall back to vulnerability url', () => {
      const vuln = createMockVulnerability({
        url: 'https://fallback.url',
        via: ['string-only'],
      });
      const url = getVulnerabilityUrl(vuln);
      expect(url).toBe('https://fallback.url');
    });

    it('should return empty string for no url', () => {
      const vuln = createMockVulnerability({
        url: '',
        via: [],
      });
      const url = getVulnerabilityUrl(vuln);
      expect(url).toBe('');
    });
  });
});
